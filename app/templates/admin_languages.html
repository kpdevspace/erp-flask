{% extends 'base.html' %}
{% block title %}Language Management{% endblock %}
{% block content %}
<h2 class="title is-3">Language Management</h2>

<div class="box">
  <form method="get" class="columns is-vcentered">
    <div class="column is-3">
      <div class="select is-fullwidth">
        <select name="scope" onchange="this.form.submit()">
          <option value="org" {% if scope == 'org' %}selected{% endif %}>Organization</option>
          <option value="global" {% if scope == 'global' %}selected{% endif %}>Global fallback</option>
        </select>
      </div>
    </div>
    <div class="column is-4">
      <div class="select is-fullwidth">
        <select name="org_id" onchange="this.form.submit()" {% if scope != 'org' %}disabled{% endif %}>
          {% for o in organizations %}
            <option value="{{ o.id }}" {% if selected_org and o.id == selected_org.id %}selected{% endif %}>{{ o.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="column is-3">
      <div class="select is-fullwidth">
        <select name="locale" onchange="this.form.submit()">
          {% for lc in supported_locales %}
            <option value="{{ lc }}" {% if lc == selected_locale %}selected{% endif %}>{{ lc|upper }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="column is-2">
      <a class="button is-light is-fullwidth" href="{{ url_for('erp.admin_languages_export_csv', scope=scope, org_id=(selected_org.id if selected_org else None), locale=selected_locale) }}">Export CSV</a>
    </div>
  </form>

  {% if selected_org and scope == 'org' %}
  <form method="post" class="mb-4">
    <input type="hidden" name="form_type" value="org_locale">
    <div class="field has-addons">
      <div class="control"><span class="button is-static">Default language</span></div>
      <div class="control">
        <div class="select">
          <select name="default_locale">
            {% for lc in supported_locales %}
              <option value="{{ lc }}" {% if selected_org.default_locale == lc %}selected{% endif %}>{{ lc|upper }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="control"><button class="button is-link">Update</button></div>
    </div>
  </form>
  {% endif %}

  <p class="is-size-7 has-text-grey mb-2">Allowed key prefixes: {{ allowed_key_prefixes|join(', ') }}</p>

  <form method="post" class="mb-5">
    <input type="hidden" name="scope" value="{{ scope }}">
    <input type="hidden" name="org_id" value="{{ selected_org.id if selected_org else '' }}">
    <input type="hidden" name="locale" value="{{ selected_locale }}">
    <div class="columns">
      <div class="column"><input class="input" name="key" placeholder="key เช่น menu.projects" required></div>
      <div class="column"><input class="input" name="value" placeholder="translated value" required></div>
      <div class="column is-2"><button class="button is-primary is-fullwidth">Save</button></div>
    </div>
  </form>

  <form method="post" action="{{ url_for('erp.admin_languages_import') }}" class="mb-5">
    <input type="hidden" name="scope" value="{{ scope }}">
    <input type="hidden" name="org_id" value="{{ selected_org.id if selected_org else '' }}">
    <input type="hidden" name="locale" value="{{ selected_locale }}">
    <label class="label">CSV Import (columns: key,value)</label>
    <textarea class="textarea" name="csv_text" rows="5" placeholder="key,value&#10;menu.projects,Projects"></textarea>
    <button class="button is-link mt-2">Import CSV Text</button>
  </form>

  <table class="table is-fullwidth is-striped">
    <thead><tr><th>Key</th><th>Value</th></tr></thead>
    <tbody>
    {% for r in rows %}
      <tr><td><code>{{ r.key }}</code></td><td>{{ r.value }}</td></tr>
    {% else %}
      <tr><td colspan="2" class="has-text-grey">No translations yet.</td></tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
